---
title: "Relationship Between Military Enlistment and Income by Zip Code"
output: html_notebook
author: Philip Menchaca
url: https://github.com/pmench/military-enlistment-and-income
---

A 2008 report by The Heritage Foundation concluded that enlisted military recruits were more likely to come from middle and upper class neighborhoods (Watkins, Shanea J, and James Sherk. 2008. “Who Serves in the U.S. Military? Demographic Characteristics of Enlisted Troops and Of Cers.” CDA08-05. Heritage Foundation Center for Data Analysis). In contrast, a 2008 study concluded that "among the working class, those who have served in the military have tended to come from poorer circumstances, while there is low representation of the children of the very rich" (Lutz, Amy. 2008. “Who Joins the Military? A Look at Race, Class, and Immigration Status.” Journal of Political & Military Sociology 36 (2): 178).



```{r}
library(tidyverse)
library(skimr)
library(moderndive)

enlist <- read_csv("../data/enlist_clean.csv", show_col_types = FALSE)
income <- read_csv("../data/10zpallagi.csv", show_col_types = FALSE)
enlist <- enlist[-c(943), ] # remove row with totals
```


Extract the zip prefix to a new column in preparation for joining enlistment and
income data, and build new data frames with only the columns of interest.
```{r}
income$zip_prefix <- str_sub(income$zipcode, 1, 3)
income_analyze <- income %>%
  select(STATE, zip_prefix, agi_stub, N1) %>%
  rename(agi_size = agi_stub, total_returns = N1)

enlist_analyze <- enlist %>%
  select(`1st 3 digits Zip Code`, Total...15) %>%
  rename(zip_prefix = `1st 3 digits Zip Code`, total_enlisted = Total...15)
```


Regroup income by Zip prefix and size of Adjusted Gross Income.
```{r}
income_analyze <- income_analyze %>%
  group_by(zip_prefix, agi_size) %>%
  summarise(total_returns = round(sum(total_returns)))

```


The IRS codes the size of adjusted gross income as follows:
_1 = $1 under $25,000_
_2 = $25,000 under $50,000_
_3 = $50,000 under $75,000_
_4 = $75,000 under $100,000_
_5 = $100,000 under $200,000_
_6 = $200,000 or more_

The middle of each range is used as a proxy for a range with a lower and upper value.
The lower value is used for code 6 as no maximum is given. This is done to simplify
the analysis since the levels of income relative to each are more important for 
this analysis than knowing exact ranges or specific incomes.
```{r}
income_analyze['agi_size'][income_analyze['agi_size'] == 1] <- 12500
income_analyze['agi_size'][income_analyze['agi_size'] == 2] <- 37500
income_analyze['agi_size'][income_analyze['agi_size'] == 3] <- 62500
income_analyze['agi_size'][income_analyze['agi_size'] == 4] <- 87500
income_analyze['agi_size'][income_analyze['agi_size'] == 5] <- 150000
income_analyze['agi_size'][income_analyze['agi_size'] == 6] <- 200000
```


Find the average income for each zip code and total population (estimated by number
of returns), join dataframes, calculate enlistment numbers per 10,000 people.
```{r}
income_analyze$income <- income_analyze$agi_size * income_analyze$total_returns

income_avg <- income_analyze %>%
  group_by(zip_prefix) %>%
  summarise(avg_income = sum(income) / sum(total_returns))

total_population <- income_analyze %>%
  summarize(population_size = sum(total_returns))

enlist_by_income <- left_join(income_avg, enlist_analyze, by='zip_prefix')

enlist_by_income <- left_join(enlist_by_income, total_population, by='zip_prefix')

enlist_by_income <- enlist_by_income %>%
  mutate(total_enlisted = ifelse(is.na(total_enlisted), 0, total_enlisted))

enlist_by_income <- enlist_by_income %>% # remove problem data that likely aggregated into one zip
  filter(zip_prefix != '000' & zip_prefix != '999')

enlist_by_income$enlist_per_10K <- (
  (enlist_by_income$total_enlisted / enlist_by_income$population_size) * 10000
)

```


Descriptive statistics.
```{r}
# enlist_by_income %>%
#  sample_n(size = 10)

enlist_by_income %>%
  summarise(
    `2010_total_enlisted` = sum(total_enlisted),
    IQR_enlist = IQR(enlist_per_10K),
    IQR_income = IQR(avg_income),
    max_enlist = max(enlist_per_10K),
    max_income = max(avg_income),
    min_enlist = min(enlist_per_10K),
    min_income = min(avg_income)
              )

enlist_by_income %>% select(enlist_per_10K, avg_income) %>% skim()

enlist_by_income %>%
  get_correlation(formula = enlist_per_10K ~ avg_income)

median(enlist_by_income$avg_income)

enlist_under_median_income <- sum(enlist_by_income[which(enlist_by_income$avg_income < 
                             median(enlist_by_income$avg_income)), "total_enlisted"])

enlist_under_median_income / sum(enlist_by_income$total_enlisted)
```


Visualize data.
```{r}
top_100_enlist <- enlist_by_income %>%
  top_n(100, enlist_per_10K)

ggplot(enlist_by_income, aes(x = avg_income, y = enlist_per_10K)) +
  geom_point(alpha = 0.3, color = 'tomato') +
  labs(
    title = '2010 Military Enlistments by Average Income of Zip Code',
    x = 'Average Income', y = 'Enlistments per 10K'
    )

ggplot(enlist_by_income, aes(x = avg_income)) +
  geom_histogram(binwidth = 1000, color = 'white', fill = 'dodgerblue4') +
  labs(
    title = '2010 Distribution of Incomes in Military Enlistments by Zip Code',
       x = 'Average Income of Zip Code', y = 'Count of Zip Code'
    )

```

Create basic regression model.
```{r}
# Log enlist per 10k and enlist by avg_income

enlist_by_income <- enlist_by_income %>%
  mutate(
    log10_avg_income = log10(avg_income),
    log10_enlist_per_10K = log10(enlist_per_10K + 1)
    )

enlist_model <- lm(log10_enlist_per_10K ~ log10_avg_income, data = enlist_by_income)
get_regression_table(enlist_model)

# enlist_per_10K = 251 - 0.003 * avg_income

ggplot(enlist_by_income, aes(x = log10(avg_income), y = log10_enlist_per_10K)) +
  geom_point(alpha = 0.3, color = 'tomato') +
  geom_smooth(method = lm, se = FALSE, color = 'dodgerblue4') +
  labs(
    title = '2010 Military Enlistments by Average Income of Zip Code',
    x = 'Average Income', y = 'Enlistments per 10K'
    )

regression_points <- get_regression_points(enlist_model, ID = 'zip_prefix')
regression_points %>%
  mutate(squared_residuals = residual^2) %>%
  summarize(sum_sq_residuals = sum(squared_residuals))

  
```


H0:there is no relationship between income and military enlistment.
vs.
HA: there is greater military enlistment among people from lower income areas.

```{r}
library(infer)

obs_diff_corr <- enlist_by_income %>% 
  specify(enlist_per_10K ~ avg_income) %>% 
  calculate(stat = "correlation")
obs_diff_corr

null_distribution_enlist <- enlist_by_income %>% 
  specify(formula = enlist_per_10K ~ avg_income) %>% 
  hypothesize(null = "independence") %>% 
  generate(reps = 1000, type = "permute") %>% 
  calculate(stat = "correlation")
null_distribution_enlist

visualise(null_distribution_enlist, bins = 30) +
  shade_p_value(obs_diff_corr, direction = 'left')

```
