---
title: "Relationship Between Military Enlistment and Income by Zip Code"
output: html_notebook
author: Philip Menchaca
editor_options: 
  chunk_output_type: console
---

```{r}
library(tidyverse)
library(skimr)
library(moderndive)

enlist <- read_csv("../data/enlist_clean.csv")
income <- read_csv("../data/10zpallagi.csv")
enlist <- enlist[-c(943), ] # remove row with totals
```


Extract the zip prefix to a new column in preparation for joining enlistment and
income data, and build new data frames with only the columns of interest.
```{r}
income$zip_prefix <- str_sub(income$zipcode, 1, 3)
income_analyze <- income %>%
  select(STATE, zip_prefix, agi_stub, N1) %>%
  rename(agi_size = agi_stub, total_returns = N1)

enlist_analyze <- enlist %>%
  select(`1st 3 digits Zip Code`, Total...15) %>%
  rename(zip_prefix = `1st 3 digits Zip Code`, total_enlisted = Total...15)
```


Regroup income by Zip prefix and size of Adjusted Gross Income.
```{r}
income_analyze <- income_analyze %>%
  group_by(zip_prefix, agi_size) %>%
  summarise(total_returns = round(sum(total_returns)))
```


The IRS codes the size of adjusted gross income as follows:
_1 = $1 under $25,000_
_2 = $25,000 under $50,000_
_3 = $50,000 under $75,000_
_4 = $75,000 under $100,000_
_5 = $100,000 under $200,000_
_6 = $200,000 or more_

The middle of each range is used as a proxy for a range with a lower and upper value.
The lower value is used for code 6 as no maximum is given. This is done to simplify
the analysis since the levels of income relative to each are more important for 
this analysis than knowing exact ranges or specific incomes.
```{r}
income_analyze['agi_size'][income_analyze['agi_size'] == 1] <- 12500
income_analyze['agi_size'][income_analyze['agi_size'] == 2] <- 37500
income_analyze['agi_size'][income_analyze['agi_size'] == 3] <- 62500
income_analyze['agi_size'][income_analyze['agi_size'] == 4] <- 87500
income_analyze['agi_size'][income_analyze['agi_size'] == 5] <- 150000
income_analyze['agi_size'][income_analyze['agi_size'] == 6] <- 200000
```


Find the average income for each zip code and total population (estimated by number
of returns), join dataframes, calculate enlistment numbers per 10,000 people.
```{r}
income_analyze$income <- income_analyze$agi_size * income_analyze$total_returns

income_avg <- income_analyze %>%
  group_by(zip_prefix) %>%
  summarise(avg_income = sum(income) / sum(total_returns))

total_population <- income_analyze %>%
  summarize(population_size = sum(total_returns))

enlist_by_income <- left_join(income_avg, enlist_analyze, by='zip_prefix')

enlist_by_income <- left_join(enlist_by_income, total_population, by='zip_prefix')

enlist_by_income <- enlist_by_income %>%
  mutate(total_enlisted = ifelse(is.na(total_enlisted), 0, total_enlisted))

enlist_by_income <- enlist_by_income %>% # remove problem data that likely aggregated into one zip
  filter(zip_prefix != '000' & zip_prefix != '999')

enlist_by_income$enlist_per_10K <- (
  (enlist_by_income$total_enlisted / enlist_by_income$population_size) * 10000
)

```


Descriptive statistics.
```{r}
enlist_by_income %>%
  sample_n(size = 10)

enlist_by_income %>%
  summarise(
    `2010_total_enlisted` = sum(total_enlisted),
    avg_enlist_per_10K = mean(enlist_per_10K)
              )

max(enlist_by_income$enlist_per_10K)
min(enlist_by_income$enlist_per_10K)
max(enlist_by_income$avg_income)
min(enlist_by_income$avg_income)

 enlist_by_income %>% select(enlist_per_10K, avg_income) %>% skim()

enlist_by_income %>%
  get_correlation(formula = enlist_per_10K ~ avg_income)

```


Visualize data.
```{r}
top_100_enlist <- enlist_by_income %>%
  top_n(100, enlist_per_10K)

ggplot(enlist_by_income, aes(x = avg_income, y = enlist_per_10K)) +
  geom_point(alpha = 0.2)

ggplot(enlist_by_income, aes(x = avg_income)) +
  geom_histogram(binwidth = 1000, color = 'white', fill = 'dodgerblue4') +
  labs(title = 'Distribution of Incomes in Military Enlistments Data 2010',
       x = 'Average Income', y = 'Count')

```


